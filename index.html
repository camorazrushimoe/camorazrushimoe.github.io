<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brick Breaker with EPAM Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: linear-gradient(to bottom right, #8F4B86, #FFFFFF); 
            font-family: 'Arial', sans-serif;
        }
        .fancy-panel {
            background: linear-gradient(to bottom right, #8F4B86, #FFFFFF);
            border-radius: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), inset 0 4px 8px rgba(255, 255, 255, 0.3);
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }
        .fancy-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transform: rotate(30deg);
        }
        canvas { 
            background: #FFFFFF; 
            display: block; 
            margin: 0 auto; 
            border: 2px solid #8F4B86; 
            border-radius: 1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #8F4B86;
            color: #FFFFFF;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .tooltip:hover::after {
            opacity: 1;
        }
        button:focus, input:focus {
            outline: 2px solid #8F4B86;
            outline-offset: 2px;
        }
        .front-page {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%238F4B86" fill-opacity="0.1"/><path d="M20,80 Q50,50 80,80" stroke="%238F4B86" stroke-width="2" fill="none"/></svg>') center/cover, linear-gradient(to bottom right, #8F4B86, #FFFFFF);
            border-radius: 2rem;
            padding: 3rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        input, button {
            transition: all 0.3s ease;
        }
        input:focus, button:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="flex flex-col justify-center items-center min-h-screen p-4">
    <!-- User Info Screen -->
    <div id="userInfoScreen" class="front-page max-w-md w-full text-white">
        <h1 class="text-4xl font-bold mb-8 text-center">EPAM Brick Breaker</h1>
        <form id="userForm" class="space-y-6">
            <div>
                <label for="name" class="block text-sm font-medium">Name</label>
                <input type="text" id="name" required class="mt-1 block w-full p-3 border border-white rounded-lg bg-white/20 text-white placeholder-white/50" placeholder="Enter your name">
            </div>
            <div>
                <label for="email" class="block text-sm font-medium">Email</label>
                <input type="email" id="email" required class="mt-1 block w-full p-3 border border-white rounded-lg bg-white/20 text-white placeholder-white/50" placeholder="Enter your email">
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="dataConsent" required class="h-5 w-5 text-white border-white rounded">
                <label for="dataConsent" class="ml-2 text-sm">I consent to personal data collection (required)</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="emailConsent" class="h-5 w-5 text-white border-white rounded">
                <label for="emailConsent" class="ml-2 text-sm">I agree to receive EPAM emails (optional)</label>
            </div>
            <button type="submit" class="tooltip w-full bg-white text-#8F4B86 py-3 rounded-lg font-semibold hover:bg-#8F4B86 hover:text-white" data-tooltip="Submit to start the game">Start Game</button>
        </form>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden relative">
        <canvas id="myCanvas" width="800" height="600" class="max-w-full h-auto" role="img" aria-label="Brick Breaker Game Canvas"></canvas>
        <div id="popup" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 fancy-panel p-6 z-50 max-w-sm text-center text-white" role="dialog" aria-modal="true" aria-labelledby="popupText">
            <p id="popupText" class="text-lg font-semibold mb-4"></p>
            <button id="popupBtn" class="tooltip bg-white text-#8F4B86 px-4 py-2 rounded-md hover:bg-#8F4B86 hover:text-white" data-tooltip="Click to continue the game" aria-label="Continue game">OK</button>
        </div>
    </div>

    <!-- Win Screen -->
    <div id="winScreen" class="hidden fancy-panel max-w-md w-full text-center text-white" role="region" aria-labelledby="result-heading">
        <h1 id="winMessage" class="text-3xl font-bold mb-4" id="result-heading"></h1>
        <p id="finalScore" class="text-lg mb-6"></p>
        <button id="quizBtn" class="tooltip bg-white text-#8F4B86 py-2 px-4 rounded-lg hover:bg-#8F4B86 hover:text-white" data-tooltip="Proceed to the EPAM quiz" aria-label="Go to Quiz">Go to Quiz</button>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="hidden fancy-panel max-w-md w-full text-white" role="region" aria-labelledby="quiz-heading">
        <h1 class="text-3xl font-bold mb-6 text-center" id="quiz-heading">EPAM Quiz</h1>
        <div id="quizContent" class="space-y-4"></div>
    </div>

    <!-- Thank You Screen -->
    <div id="thankYouScreen" class="hidden fancy-panel max-w-md w-full text-center text-white" role="region" aria-labelledby="thankyou-heading">
        <h1 class="text-3xl font-bold mb-4" id="thankyou-heading">Thank You!</h1>
        <p class="text-lg mb-6">Thanks for playing and learning about EPAM!</p>
        <button id="exportBtn" class="tooltip bg-white text-#8F4B86 py-2 px-4 rounded-lg hover:bg-#8F4B86 hover:text-white" data-tooltip="Download completed users data as CSV" aria-label="Export Completed Users">Export Completed Users</button>
    </div>

    <script>
        // Local storage for user data
        function saveUserData(name, email, dataConsent, emailConsent, completedQuiz = false) {
            const userData = {
                name: name,
                email: email,
                dataConsent: dataConsent,
                emailConsent: emailConsent,
                completedQuiz: completedQuiz,
                timestamp: new Date().toISOString()
            };
            let users = JSON.parse(localStorage.getItem('brickBreakerUsers') || '[]');
            users.push(userData);
            localStorage.setItem('brickBreakerUsers', JSON.stringify(users));
            return users.length - 1;
        }

        function updateUserCompletedQuiz(index) {
            let users = JSON.parse(localStorage.getItem('brickBreakerUsers') || '[]');
            if (users[index]) {
                users[index].completedQuiz = true;
                localStorage.setItem('brickBreakerUsers', JSON.stringify(users));
            }
        }

        function exportCompletedUsers() {
            let users = JSON.parse(localStorage.getItem('brickBreakerUsers') || '[]');
            let completed = users.filter(u => u.completedQuiz);
            if (completed.length === 0) {
                alert('No users have completed the quiz yet.');
                return;
            }
            let csv = 'Name,Email,DataConsent,EmailConsent,Timestamp\n';
            completed.forEach(u => {
                csv += `"${u.name.replace(/"/g, '""')}",${u.email},${u.dataConsent},${u.emailConsent},${u.timestamp}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'completed_users.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // User Info Form Handling
        let currentUserIndex;
        const userForm = document.getElementById('userForm');
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const dataConsent = document.getElementById('dataConsent').checked;
            const emailConsent = document.getElementById('emailConsent').checked;
            if (dataConsent && name && email) {
                currentUserIndex = saveUserData(name, email, dataConsent, emailConsent);
                document.getElementById('userInfoScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                startGame();
            }
        });

        // Ensure form inputs are editable
        document.getElementById('name').addEventListener('input', function(e) {
            this.value = e.target.value;
        });
        document.getElementById('email').addEventListener('input', function(e) {
            this.value = e.target.value;
        });

        // Game Logic (unchanged)
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var ballRadius = 10;
        var x = canvas.width / 2;
        var y = canvas.height - 30;
        var dx = 3;
        var dy = -3;
        var paddleHeight = 10;
        var paddleWidth = 100;
        var paddleX = (canvas.width - paddleWidth) / 2;
        var rightPressed = false;
        var leftPressed = false;
        var smallBrickWidth = 70;
        var smallBrickHeight = 20;
        var bigBrickWidth = smallBrickWidth * 2 + 5;
        var bigBrickHeight = smallBrickHeight * 2 + 5;
        var brickPadding = 5;
        var brickOffsetTop = 30;
        var cellColCount = 10;
        var cellRowCount = 8;
        var cellStepX = smallBrickWidth + brickPadding;
        var cellStepY = smallBrickHeight + brickPadding;
        var brickOffsetLeft = (canvas.width - (cellColCount * smallBrickWidth + (cellColCount - 1) * brickPadding)) / 2;
        var score = 0;
        var lives = 3;
        var paused = false;

        var occupied = Array.from({length: cellRowCount}, () => Array(cellColCount).fill(false));
        var bigPositions = [];
        var bigCount = 0;
        while (bigCount < 10) {
            var c = Math.floor(Math.random() * (cellColCount - 1));
            var r = Math.floor(Math.random() * (cellRowCount - 1));
            if (!occupied[r][c] && !occupied[r][c + 1] && !occupied[r + 1][c] && !occupied[r + 1][c + 1]) {
                occupied[r][c] = true;
                occupied[r][c + 1] = true;
                occupied[r + 1][c] = true;
                occupied[r + 1][c + 1] = true;
                bigPositions.push({r: r, c: c});
                bigCount++;
            }
        }

        var bricks = [];
        for (var i = 0; i < bigPositions.length; i++) {
            var pos = bigPositions[i];
            var brickX = brickOffsetLeft + pos.c * cellStepX;
            var brickY = brickOffsetTop + pos.r * cellStepY;
            bricks.push({ x: brickX, y: brickY, width: bigBrickWidth, height: bigBrickHeight, status: 1, isBig: true });
        }
        for (var r = 0; r < cellRowCount; r++) {
            for (var c = 0; c < cellColCount; c++) {
                if (!occupied[r][c]) {
                    var brickX = brickOffsetLeft + c * cellStepX;
                    var brickY = brickOffsetTop + r * cellStepY;
                    bricks.push({ x: brickX, y: brickY, width: smallBrickWidth, height: smallBrickHeight, status: 1, isBig: false });
                }
            }
        }

        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);
        document.addEventListener("mousemove", mouseMoveHandler, false);
        document.addEventListener("touchmove", touchMoveHandler, false);

        function keyDownHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") rightPressed = true;
            else if (e.key === "Left" || e.key === "ArrowLeft") leftPressed = true;
        }

        function keyUpHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") rightPressed = false;
            else if (e.key === "Left" || e.key === "ArrowLeft") leftPressed = false;
        }

        function mouseMoveHandler(e) {
            var relativeX = e.clientX - canvas.offsetLeft;
            if (relativeX > 0 && relativeX < canvas.width) {
                paddleX = relativeX - paddleWidth / 2;
            }
        }

        function touchMoveHandler(e) {
            var relativeX = e.touches[0].clientX - canvas.offsetLeft;
            if (relativeX > 0 && relativeX < canvas.width) {
                paddleX = relativeX - paddleWidth / 2;
            }
        }

        var popup = document.getElementById("popup");
        var popupText = document.getElementById("popupText");
        var popupBtn = document.getElementById("popupBtn");
        popupBtn.addEventListener("click", function() {
            popup.classList.add("hidden");
            paused = false;
        });

        function showPopup(message) {
            popupText.innerText = message;
            popup.classList.remove("hidden");
            paused = true;
            popupBtn.focus();
        }

        function drawBall() {
            ctx.beginPath();
            ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
            ctx.fillStyle = "#8F4B86";
            ctx.fill();
            ctx.closePath();
        }

        function drawPaddle() {
            ctx.beginPath();
            ctx.rect(paddleX, canvas.height - paddleHeight, paddleWidth, paddleHeight);
            ctx.fillStyle = "#8F4B86";
            ctx.fill();
            ctx.closePath();
        }

        function drawBricks() {
            for (var i = 0; i < bricks.length; i++) {
                var brick = bricks[i];
                if (brick.status > 0) {
                    ctx.beginPath();
                    ctx.rect(brick.x, brick.y, brick.width, brick.height);
                    ctx.fillStyle = brick.isBig ? "#FF0000" : "#8F4B86";
                    ctx.fill();
                    ctx.closePath();
                }
            }
        }

        function collisionDetection() {
            for (var i = 0; i < bricks.length; i++) {
                var b = bricks[i];
                if (b.status > 0) {
                    if (x > b.x && x < b.x + b.width && y > b.y && y < b.y + b.height) {
                        dy = -dy;
                        b.status--;
                        score++;
                        if (b.status === 0 && b.isBig) {
                            showPopup("Congratulations! You destroyed a massive brick!");
                        }
                    }
                }
            }
        }

        function bricksRemaining() {
            var count = 0;
            for (var i = 0; i < bricks.length; i++) {
                if (bricks[i].status > 0) count++;
            }
            return count;
        }

        function drawScore() {
            ctx.font = "16px Arial";
            ctx.fillStyle = "#8F4B86";
            ctx.fillText("Score: " + score, 8, 20);
        }

        function drawLives() {
            ctx.font = "16px Arial";
            ctx.fillStyle = "#8F4B86";
            ctx.fillText("Lives: " + lives, canvas.width - 65, 20);
        }

        function draw() {
            if (paused) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBricks();
            drawBall();
            drawPaddle();
            drawScore();
            drawLives();
            collisionDetection();

            if (x + dx > canvas.width - ballRadius || x + dx < ballRadius) {
                dx = -dx;
            }
            if (y + dy < ballRadius) {
                dy = -dy;
            } else if (y + dy > canvas.height - ballRadius) {
                if (x > paddleX && x < paddleX + paddleWidth) {
                    dy = -dy;
                } else {
                    lives--;
                    if (lives === 0) {
                        document.getElementById('gameScreen').classList.add('hidden');
                        document.getElementById('winScreen').classList.remove('hidden');
                        document.getElementById('winMessage').innerText = "GAME OVER";
                        document.getElementById('finalScore').innerText = "Your score: " + score;
                        clearInterval(interval);
                        return;
                    } else {
                        x = canvas.width / 2;
                        y = canvas.height - 30;
                        dx = 3;
                        dy = -3;
                        paddleX = (canvas.width - paddleWidth) / 2;
                    }
                }
            }

            if (rightPressed && paddleX < canvas.width - paddleWidth) {
                paddleX += 7;
            }
            if (leftPressed && paddleX > 0) {
                paddleX -= 7;
            }

            x += dx;
            y += dy;

            if (bricksRemaining() === 0) {
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('winScreen').classList.remove('hidden');
                document.getElementById('winMessage').innerText = "Congratulations! You won!";
                document.getElementById('finalScore').innerText = "Your score: " + score;
                clearInterval(interval);
                return;
            }
        }

        var interval;

        function startGame() {
            interval = setInterval(draw, 10);
        }

        // Quiz Logic
        const quizQuestions = [
            {
                question: "What is EPAM's unofficial mascot in its office lore?",
                options: ["Code Ninja", "Pixel Panda", "Bug Buster", "Cloud Dragon"],
                correct: "Pixel Panda"
            },
            {
                question: "Which quirky tradition do EPAM developers celebrate annually?",
                options: ["Pizza Hackathon", "Code & Coffee Day", "Bug Bash Fiesta", "Tech Karaoke Night"],
                correct: "Code & Coffee Day"
            },
            {
                question: "What’s the name of EPAM’s legendary internal hackathon?",
                options: ["CodeStorm", "TechTango", "HackSavvy", "ByteBlitz"],
                correct: "ByteBlitz"
            }
        ];

        let currentQuestionIndex = 0;

        function showQuestion() {
            const quizContent = document.getElementById('quizContent');
            const question = quizQuestions[currentQuestionIndex];
            quizContent.innerHTML = `
                <p class="text-lg font-semibold">${question.question}</p>
                <div class="space-y-2">
                    ${question.options.map(opt => `
                        <button class="tooltip w-full bg-white/20 hover:bg-white/30 p-2 rounded-lg text-left transition duration-300 quiz-option" data-tooltip="Select this answer" data-answer="${opt}" aria-label="Answer: ${opt}">${opt}</button>
                    `).join('')}
                </div>
            `;
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.answer === question.correct) {
                        currentQuestionIndex++;
                        if (currentQuestionIndex < quizQuestions.length) {
                            showQuestion();
                        } else {
                            updateUserCompletedQuiz(currentUserIndex);
                            document.getElementById('quizScreen').classList.add('hidden');
                            document.getElementById('thankYouScreen').classList.remove('hidden');
                        }
                    }
                });
            });
        }

        document.getElementById('quizBtn').addEventListener('click', function() {
            document.getElementById('winScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            showQuestion();
        });

        document.getElementById('exportBtn').addEventListener('click', exportCompletedUsers);
    </script>
</body>
</html>
